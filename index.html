<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rooster Crow Counter ‚Äî AI + Stats + CSV</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #222; }
    #logs { width: 100%; height: 100px; }
    .settings, .logs, .charts { margin-top: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    .settings label { display: block; margin: 5px 0; }
    button { margin: 5px 5px 5px 0; }
  </style>
</head>
<body>
  <h1>üêì Rooster Crow Counter ‚Äî AI + Stats + CSV</h1>

  <div>
    <button id="startBtn">Start Listening</button>
    <p>Status: <span id="status">Idle</span></p>
    <p>Detected: <span id="detected">‚Äî</span></p>
    <p>Session Count: <span id="sessionCount">0</span></p>
    <p>Today (logs) total: <span id="todayCount">0</span></p>
    <textarea id="logs" readonly></textarea>
  </div>

  <!-- Settings Panel -->
  <div class="settings">
    <h3>‚öôÔ∏è Settings</h3>

    <label>Model Confidence Threshold:
      <input type="range" id="confidenceThreshold" min="0" max="1" step="0.01" value="0.6">
    </label>

    <label><input type="checkbox" id="useFrequency" checked> Use Frequency Filter (optional)</label>

    <label>Band Threshold (energy):
      <input type="range" id="bandThreshold" min="0" max="100" step="1" value="30">
    </label>

    <label>Band Start Frequency (Hz):
      <input type="number" id="bandStart" value="800" min="0" max="22050">
    </label>

    <label>Band End Frequency (Hz):
      <input type="number" id="bandEnd" value="2000" min="0" max="22050">
    </label>

    <label>Cooldown (ms):
      <input type="range" id="cooldown" min="100" max="10000" step="100" value="2000">
    </label>

    <button onclick="saveSettings()">Save Settings</button>
    <button onclick="resetSession()">Reset Session Count</button>
    <button onclick="clearLogs()">Clear Logs</button>
    <button onclick="exportLogs()">Export Logs (CSV)</button>
  </div>

  <!-- Logs -->
  <div class="logs">
    <h3>üìä Logs</h3>
    <h4>Today ‚Äî hourly</h4>
    <table border="1" id="hourlyLog">
      <tr><th>Hour</th><th>Count</th></tr>
    </table>

    <h4>Daily totals</h4>
    <table border="1" id="dailyLog">
      <tr><th>Date</th><th>Count</th></tr>
    </table>
  </div>

  <!-- Load Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/sound@0.8/dist/teachablemachine-sound.min.js"></script>

  <script>
    let model, microphone, isListening = false;
    let sessionCount = 0, todayCount = 0, logs = [];
    let settings = {
      confidenceThreshold: 0.6,
      useFrequency: true,
      bandThreshold: 30,
      bandStart: 800,
      bandEnd: 2000,
      cooldown: 2000
    };
    let lastDetected = 0;

    async function init() {
      const modelURL = "model.json"; // must exist in repo
      model = await tmSound.load(modelURL);
      document.getElementById("status").innerText = "Ready";
    }

    async function startListening() {
      if (!model) await init();
      if (!microphone) microphone = new tmSound.Microphone();
      await microphone.setup();
      microphone.play();
      isListening = true;
      document.getElementById("status").innerText = "Listening...";
      listenLoop();
    }

    async function listenLoop() {
      if (!isListening) return;
      const prediction = await model.predict(microphone);
      let high = prediction.reduce((a,b) => a.probability > b.probability ? a : b);

      let now = Date.now();
      if (high.probability > settings.confidenceThreshold &&
          now - lastDetected > settings.cooldown) {
        lastDetected = now;
        logDetection(high.className);
      }

      requestAnimationFrame(listenLoop);
    }

    function logDetection(label) {
      sessionCount++;
      todayCount++;
      document.getElementById("detected").innerText = label;
      document.getElementById("sessionCount").innerText = sessionCount;
      document.getElementById("todayCount").innerText = todayCount;

      let time = new Date().toLocaleTimeString();
      logs.push({ time, label });
      document.getElementById("logs").value += `[${time}] ${label}\n`;
    }

    function saveSettings() {
      settings.confidenceThreshold = parseFloat(document.getElementById("confidenceThreshold").value);
      settings.useFrequency = document.getElementById("useFrequency").checked;
      settings.bandThreshold = parseInt(document.getElementById("bandThreshold").value);
      settings.bandStart = parseInt(document.getElementById("bandStart").value);
      settings.bandEnd = parseInt(document.getElementById("bandEnd").value);
      settings.cooldown = parseInt(document.getElementById("cooldown").value);
      alert("Settings saved!");
    }

    function resetSession() {
      sessionCount = 0;
      document.getElementById("sessionCount").innerText = 0;
    }

    function clearLogs() {
      logs = [];
      document.getElementById("logs").value = "";
    }

    function exportLogs() {
      let csv = "time,label\n" + logs.map(l => `${l.time},${l.label}`).join("\n");
      let blob = new Blob([csv], { type: "text/csv" });
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url;
      a.download = "crow_logs.csv";
      a.click();
    }

    document.getElementById("startBtn").addEventListener("click", startListening);
  </script>
</body>
</html>
